<!DOCTYPE html>
<html>
<head>
    <title>Cookie Test</title>
</head>
<body>
    <script>
        if (document.cookie == "") {
            //No Cookie has been set previously, so set it now
            var params = getParams(window.location.href); //get all GET paramaters from URL
            var validEmail = "";
            if ("email" in params) { // check if email is provided in GET
                if (validateEmail(params["email"])) { //validate if email is in correct format
                    cosole.log("Valid Email is provided");
                    validEmail = "email=" + params["email"] + ";";// will add it to cookie below
                }
            }

            var c = new Date(), e = new Date();
            var expiryDays = 30; // expiry for 30 days
            e.setTime(c.getTime() + (expiryDays * 24 * 60 * 60 * 1000)); 
            var initialDate = "initial=" + c.toUTCString() + ";";
            var expires = "expires=" + e.toUTCString() + ";";
            document.cookie = initialDate + validEmail + expires;
            console.log("Cookie set properly");
        } else {
            //Cookie has been set previously, so return values
            try{
                // check if initialDate is set in cookie, if set get the value
                var initialDate = new Date(document.cookie.split(';').find(row => row.trim().startsWith('initial=')).split("=")[1]);
                var email = "";
                try{
                    // check if email is set in cookie, if set get the value
                    email = document.cookie.split(';').find(row => row.trim().startsWith('email=')).split("=")[1];                    
                }catch{
                    console.log("No email set in cookie.");
                }
                var elapsedDays = (Date.now() - initialDate)/(1000*60*60*24); // convert initialDate to elaped days
                var daysCheck = 4; 
                if(elapsedDays > daysCheck){ // if initialDate passed 4 days, perform redirection
                    redirectTo(); // 4 days have passed, redirect
                }else{
                    // initialDate hasn't passed 4 days
                }

            }catch{
                console.log("Cookie is set but, does not have initial datetime.");
            }
        }

        function getParams(url) {
            try {
                var params = {};
                var parser = document.createElement('a');
                parser.href = url;
                var query = parser.search.substring(1);
                var vars = query.split('&');
                for (var i = 0; i < vars.length; i++) {
                    var pair = vars[i].split('=');
                    params[pair[0]] = decodeURIComponent(pair[1]);
                }
                return params;
            } catch{
                return {}
            }
        }

        function validateEmail(email) {
            if (/^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/.test(email)) {
                return true
            }
            return false
        }

        function redirectTo(){
            console.log("Provide url for redirection");
            // location.href = "url";
        }
    </script>
</body>

</html>
